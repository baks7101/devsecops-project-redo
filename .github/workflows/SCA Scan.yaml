name: SCA Scan Project 3

on:
  push:
    branches:
      - main

jobs:
  sca-trivy:
    name: Build and scan with Trivy
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout your vulnerable Flask app + Dockerfile + requirements.txt
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Docker buildx so we can build the image from THIS repo
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Build Docker image FROM your app in this repo
      #    (assumes Dockerfile is in repo root and uses app.py + requirements.txt)
      - name: Build Docker image
        run: |
          docker build -t baks7101/dockerhub:baks .

      # 4. Trivy SCA on the repo (filesystem scan)
      #    This looks at requirements.txt etc.
      - name: Trivy SCA on repository (filesystem)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          ignore-unfixed: true

      # 5. Trivy scan on the Docker image we just built
      - name: Trivy scan on Docker image
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'image'
          image-ref: 'baks7101/dockerhub:baks'
          format: 'table'
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          ignore-unfixed: true

  